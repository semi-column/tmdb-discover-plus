name: Nightly Build

on:
  push:
    branches: [main]
    paths:
      - 'server/**'
      - 'client/src/**'
      - 'client/public/**'
      - 'package.json'
      - 'package-lock.json'

# Ensure only one nightly build runs at a time
concurrency:
  group: nightly-build
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  # Skip if this is a release-please commit
  check:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check commit message
        id: check
        run: |
          if [[ "${{ github.event.head_commit.message }}" =~ ^(chore:|docs:|ci:) ]]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping nightly build for chore/docs/ci commit"
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

  nightly:
    name: Build & Deploy Nightly
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.should_run == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate nightly tag
        id: gen_tag
        run: |
          TIMESTAMP=$(date -u '+%Y.%m.%d.%H%M-nightly')
          echo "tag_name=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "Generated tag: $TIMESTAMP"

      - name: Get last nightly tag
        id: get_last_nightly
        run: |
          LAST_TAG=$(git tag -l "*-nightly" --sort=-committerdate | head -n 1 || echo "")
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "Last nightly tag: ${LAST_TAG:-none}"

      - name: Get commit messages since last nightly
        id: commits
        run: |
          if [ -z "${{ steps.get_last_nightly.outputs.last_tag }}" ]; then
            MSGS=$(git log --pretty=format:"* %s (%h)" -n 20)
          else
            MSGS=$(git log "${{ steps.get_last_nightly.outputs.last_tag }}"..HEAD --pretty=format:"* %s (%h)")
          fi
          
          if [ -z "$MSGS" ]; then
            MSGS="* Automated nightly build"
          fi
          
          echo "messages<<EOF" >> $GITHUB_OUTPUT
          echo "$MSGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create git tag
        env:
          TAG_NAME: ${{ steps.gen_tag.outputs.tag_name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag $TAG_NAME
          git push origin $TAG_NAME

      - name: Create GitHub pre-release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: ${{ steps.gen_tag.outputs.tag_name }}
          COMMIT_MSGS: ${{ steps.commits.outputs.messages }}
        run: |
          NOTES=$(cat <<'EOF'
          ## ðŸŒ™ Nightly Build
          
          **Tag:** ${{ steps.gen_tag.outputs.tag_name }}
          **Commit:** ${{ github.sha }}
          **Branch:** main
          
          ### Changes since last nightly:
          ${{ steps.commits.outputs.messages }}
          
          ---
          
          âš ï¸ **Warning:** This is a development build intended for testing. Use at your own risk.
          
          ðŸ”— **Test URL:** https://84f50d1c22e7-tmdb-discover-plus.baby-beamup.club/
          
          ðŸ“¦ **Stable Version:** For production use, please use the latest stable release.
          EOF
          )
          
          gh release create "$TAG_NAME" \
            --repo "${{ github.repository }}" \
            --title "ðŸŒ™ Nightly: $TAG_NAME" \
            --notes "$NOTES" \
            --prerelease

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd server && npm ci
          cd ../client && npm ci

      - name: Run server tests
        env:
          PORT: 7000
          JWT_SECRET: 'nightly-test-secret'
          ENCRYPTION_KEY: '0000000000000000000000000000000000000000000000000000000000000000'
        run: cd server && npm test

      - name: Run client tests
        run: cd client && npm test

      - name: Generate build metadata
        run: |
          node -e "
          const fs = require('fs');
          const { execSync } = require('child_process');
          const pkg = require('./package.json');
          
          const metadata = {
            version: pkg.version,
            tag: '${{ steps.gen_tag.outputs.tag_name }}',
            channel: 'nightly',
            commitHash: '${{ github.sha }}'.substring(0, 7),
            buildTime: new Date().toISOString(),
          };
          
          fs.writeFileSync('server/src/metadata.json', JSON.stringify(metadata, null, 2));
          console.log('Generated metadata:', metadata);
          "

      - name: Build client
        run: cd client && npm run build

      - name: Configure Git for deploy
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Add built files to deploy commit
        run: |
          git add -f client/dist/
          git add -f server/src/metadata.json
          git commit -m "Nightly build ${{ steps.gen_tag.outputs.tag_name }} [skip ci]" --allow-empty

      - name: Setup SSH for BeamUp
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BEAMUP_SSH_KEY }}" > ~/.ssh/beamup_key
          chmod 600 ~/.ssh/beamup_key
          ssh-keyscan -H a.baby-beamup.club >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to BeamUp
        env:
          GIT_SSH_COMMAND: 'ssh -i ~/.ssh/beamup_key -o StrictHostKeyChecking=no'
        run: |
          git remote add beamup dokku@a.baby-beamup.club:84f50d1c22e7-tmdb-discover-plus || true
          git push beamup HEAD:main --force

      - name: Deployment Summary
        run: |
          echo "## ðŸŒ™ Nightly Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | \`${{ steps.gen_tag.outputs.tag_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | https://84f50d1c22e7-tmdb-discover-plus.baby-beamup.club/ |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployed at** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes in this build:" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.commits.outputs.messages }}" >> $GITHUB_STEP_SUMMARY
