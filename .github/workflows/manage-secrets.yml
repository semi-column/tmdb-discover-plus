name: Manage BeamUp Secrets

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'set'
        type: choice
        options:
          - set
          - unset
      key:
        description: 'Environment Variable Name (KEY)'
        required: true
      value:
        description: 'Value (required for set)'
        required: false

jobs:
  manage-secrets:
    name: Manage Secrets
    runs-on: ubuntu-latest
    if: github.actor == 'semi-column'

    steps:
      - name: Validate Input
        run: |
          if [[ "${{ github.event.inputs.action }}" == "set" && -z "${{ github.event.inputs.value }}" ]]; then
            echo "âŒ Error: Value is required for 'set' action"
            exit 1
          fi

      - name: Setup SSH for BeamUp
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BEAMUP_SSH_KEY }}" > ~/.ssh/beamup_key
          chmod 600 ~/.ssh/beamup_key
          ssh-keyscan -H a.baby-beamup.club >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Execute BeamUp Command
        env:
          SSH_CMD: 'ssh -i ~/.ssh/beamup_key -o StrictHostKeyChecking=no dokku@a.baby-beamup.club'
          APP_NAME: '84f50d1c22e7-tmdb-discover-plus'
          KEY: ${{ github.event.inputs.key }}
          VALUE: ${{ github.event.inputs.value }}
        run: |
          if [ "${{ github.event.inputs.action }}" == "set" ]; then
            echo "Setting $KEY..."
            # Using specific syntax to handle values with spaces or special chars if possible, 
            # though dokku config:set usually takes KEY=VALUE
            $SSH_CMD config:set $APP_NAME "$KEY=$VALUE"
          else
            echo "Unsetting $KEY..."
            $SSH_CMD config:unset $APP_NAME "$KEY"
          fi

      - name: Summary
        run: |
          echo "## ðŸ” Secret Management Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** \`${{ github.event.inputs.action }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Key:** \`${{ github.event.inputs.key }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**App:** \`84f50d1c22e7-tmdb-discover-plus\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
